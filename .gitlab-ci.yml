image: "nexus.bz-openlab.ru:10443/huawei/koala-ci:0.2"

stages:
  - test

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "pipeline"
    - if: $CI_PIPELINE_SOURCE == "parent_pipeline"

variables:
  GIT_SUBMODULE_STRATEGY: recursive

.setup:
    script:
        - npm config set registry https://repo.huaweicloud.com/repository/npm/
        - npm config set @ohos:registry https://repo.harmonyos.com/npm/
        - npm config set @koalaui:registry https://nexus.bz-openlab.ru:10443/repository/koala-npm/
        - npm config set //nexus.bz-openlab.ru:10443/repository/koala-npm/:_auth $NEXUS_NPM_PASS
        - npm i --no-audit --no-fund


pg check peers dts:
  stage: test
  tags:
    - idlize-ci
    - koala-ci
  before_script:
    - !reference [.setup, script]
  script:
    - npm run check:peers:dts

idlize sanity:
  stage: test
  tags:
    - idlize-ci
    - koala-ci
  before_script:
    - !reference [.setup, script]
  script:
    - npm run sanity

pg java:run:
  stage: test
  tags:
    - idlize-ci
    - koala-ci
  before_script:
    - !reference [.setup, script]
  script:
    - JAVA_HOME=/usr/lib/jvm/java-11-openjdk-arm64 npm run run:java

publish idlize:
    stage: test
    tags:
      - idlize-ci
      - koala-ci
    rules:
      - if: $CI_PIPELINE_SOURCE == "schedule"
        when: never
      - if: $CI_COMMIT_BRANCH == "master"
        when: on_success
    before_script:
      - !reference [.setup, script]
    script:
        - cd $CI_PROJECT_DIR
        - sed -i "s/+devel/-dev.$CI_PIPELINE_IID/" package.json
        - KOALA_BZ=1 npm run upload

