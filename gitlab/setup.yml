.setup:
    script:
        - npm config set @ohos:registry https://repo.harmonyos.com/npm/
        - npm config set @koalaui:registry https://nexus.cn.bz-openlab.ru:10443/repository/koala-npm/
        - npm config set @azanat:registry https://nexus.cn.bz-openlab.ru:10443/repository/koala-npm/
        - npm config set @idlizer:registry https://nexus.cn.bz-openlab.ru:10443/repository/koala-npm/
        - npm config set @panda:registry https://nexus.cn.bz-openlab.ru:10443/repository/koala-npm/
        - npm config set //nexus.cn.bz-openlab.ru:10443/repository/koala-npm/:_auth $NEXUS_NPM_PASS
        - npm i --prefix external --no-audit --no-fund
        - npm i --no-audit --no-fund
    libarkts:
        - cd external/ui2abc/libarkts
        - npm run reinstall:regenerate
        - npm run compile
        - npm run compile:plugins
        - cd -
    panda-sdk:
        - PANDA_SDK_VERSION=1.5.0-dev.31052 npm run panda:sdk:check-install --prefix ./external/incremental/tools/panda

.npm-cache: &npm-cache
    paths:
    - .npm/

.npm-config-scripts: &npm-config-script
    - npm config set cache $(pwd)/.npm
    - npm config set @ohos:registry https://repo.harmonyos.com/npm/
    - npm config set @koalaui:registry https://nexus.cn.bz-openlab.ru:10443/repository/koala-npm/
    - npm config set @azanat:registry https://nexus.cn.bz-openlab.ru:10443/repository/koala-npm/
    - npm config set @idlizer:registry https://nexus.cn.bz-openlab.ru:10443/repository/koala-npm/
    - npm config set @panda:registry https://nexus.cn.bz-openlab.ru:10443/repository/koala-npm/
    - npm config set //nexus.cn.bz-openlab.ru:10443/repository/koala-npm/:_auth $NEXUS_NPM_PASS

npm install:
    stage: build
    script:
    - *npm-config-script
    - npm i --prefix external --no-audit --no-fund
    - npm i --no-audit --no-fund
    cache: *npm-cache
    artifacts:
        paths:
        - "**/node_modules"
        expire_in: 1 day

panda sdk install:
    stage: build
    needs:
    - npm install
    script:
    - *npm-config-script
    - PANDA_SDK_VERSION=1.5.0-dev.32627 npm run panda:sdk:check-install --prefix ./external/incremental/tools/panda
    cache: *npm-cache
    artifacts:
        paths:
        - ./external/incremental/tools/panda/node_modules
        expire_in: 1 day

libarkts regenerate:
    stage: build
    needs:
    - npm install
    - panda sdk install
    script:
    - *npm-config-script
    - cd external/ui2abc/libarkts
    - npm run regenerate
    - npm run compile
    - npm run compile:plugins
    - cd -
    cache: *npm-cache
    artifacts:
        paths:
        - external/ui2abc/libarkts/lib
        - external/ui2abc/libarkts/build
        expire_in: 1 day

download sdk:
    stage: build
    needs:
    - npm install
    script:
    - *npm-config-script
    - npm run download:sdk
    cache: *npm-cache
    artifacts:
        paths:
        - sdk-patched
        - sdk-patched-arkts
        expire_in: 1 day