include:
    - gitlab/npm.yml

.panda:
    script:
    - npm run panda:sdk:check-install --prefix ./external/incremental/tools/panda

prepare caches:
    stage: pre-build
    tags:
    - idlize-ci
    - koala-ci
    script:
    - !reference [.npm, script]
    - !reference [.panda, script]
    cache:
    -   key: $CI_PIPELINE_ID
        policy: pull-push
        paths:
        - .npm/

libarkts regenerate:
    stage: build
    tags:
    - idlize-ci
    - koala-ci
    script:
    - !reference [.npm, script]
    - !reference [.panda, script]
    - cd external/ui2abc/libarkts
    - npm run regenerate
    - npm run compile
    - npm run compile:plugins
    - cd -
    artifacts:
        paths:
        - external/ui2abc/libarkts/lib
        - external/ui2abc/libarkts/build
        expire_in: 1 day

download sdk:
    stage: build
    tags:
    - idlize-ci
    - koala-ci
    script:
    - !reference [.npm, script]
    - !reference [.panda, script]
    - npm run download:sdk
    needs:
    - prepare caches
    - libarkts regenerate
    artifacts:
        paths:
        - sdk-patched
        - sdk-patched-arkts
        expire_in: 1 day