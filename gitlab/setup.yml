include:
    - gitlab/npm.yml

npm install:
    stage: build
    tags:
    - idlize-ci
    - koala-ci
    script:
    - !reference [.npm-config-script]
    - npm i --prefix external --no-audit --no-fund
    - npm i --no-audit --no-fund
    cache: !reference [.npm-cache]
    artifacts:
        paths:
        - "**/node_modules"
        expire_in: 1 day

panda sdk install:
    stage: build
    tags:
    - idlize-ci
    - koala-ci
    needs:
    - npm install
    script:
    - !reference [.npm-config-script]
    - PANDA_SDK_VERSION=1.5.0-dev.32627 npm run panda:sdk:check-install --prefix ./external/incremental/tools/panda
    cache: !reference [.npm-cache]
    artifacts:
        paths:
        - ./external/incremental/tools/panda/node_modules
        expire_in: 1 day

libarkts regenerate:
    stage: build
    tags:
    - idlize-ci
    - koala-ci
    needs:
    - npm install
    - panda sdk install
    script:
    - !reference [.npm-config-script]
    - cd external/ui2abc/libarkts
    - npm run regenerate
    - npm run compile
    - npm run compile:plugins
    - cd -
    cache: !reference [.npm-cache]
    artifacts:
        paths:
        - external/ui2abc/libarkts/lib
        - external/ui2abc/libarkts/build
        expire_in: 1 day

download sdk:
    stage: build
    tags:
    - idlize-ci
    - koala-ci
    needs:
    - npm install
    script:
    - !reference [.npm-config-script]
    - npm run download:sdk
    cache: !reference [.npm-cache]
    artifacts:
        paths:
        - sdk-patched
        - sdk-patched-arkts
        expire_in: 1 day