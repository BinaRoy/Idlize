include:
    - gitlab/npm.yml

.panda:
    script:
    - npm run panda:sdk:install --prefix ./external/ui2abc/libarkts
    - npm ls @panda/sdk --prefix ./external/incremental/tools/panda

prepare caches:
    stage: pre-build
    tags:
    - idlize-ci
    - koala-ci
    script:
    - !reference [.npm, script]
    - !reference [.panda, script]
    cache:
    -   key: $CI_PIPELINE_ID
        policy: pull-push
        paths:
        - .npm/

build external:
    stage: build
    tags:
    - idlize-ci
    - koala-ci
    script:
    - !reference [.npm, script]
    - !reference [.panda, script]
    - cd external/ui2abc/libarkts
    - npm run regenerate
    - npm run compile
    - npm run compile:plugins
    - cd -
    - npm run compile --prefix external/ui2abc/annotate
    - npm run compile --prefix external/ui2abc/fast-arktsc
    - npm run compile --prefix external/ui2abc/memo-plugin
    - npm run compile --prefix external/ui2abc/ui-plugins
    - npm i --prefix external/ui2abc/annotate
    - npm run compile --prefix external/ui2abc/annotate
    - npm run annotate --prefix external/incremental/runtime
    - npm run annotate:tests --prefix external/incremental/runtime
    - npm run compile --prefix external/interop
    - npm run compile --prefix external/incremental/common
    - npm run compile --prefix external/incremental/compat
    - npm run compile --prefix external/incremental/runtime
    - npm run build --prefix external/interop
    - npm run build --prefix external/incremental
    artifacts:
        paths:
        - external/ui2abc/libarkts/lib
        - external/ui2abc/libarkts/build
        - external/ui2abc/annotate/lib
        - external/ui2abc/fast-arktsc/lib
        - external/ui2abc/memo-plugin/lib
        - external/ui2abc/ui-plugins/lib
        - external/incremental/common/build/lib
        - external/incremental/compat/build
        - external/incremental/runtime/build/lib
        - external/incremental/runtime/build/incremental.abc
        - external/incremental/runtime/ets
        - external/incremental/runtime/ets-test
        - external/interop/build/lib
        - external/interop/build/interop.abc
        # need these symlinks for require in es2panda.js to work
        - external/ui2abc/node_modules/@koalaui/memo-plugin
        - external/ui2abc/node_modules/@koalaui/ui-plugins
        expire_in: 1 day

download sdk:
    stage: build
    tags:
    - idlize-ci
    - koala-ci
    script:
    - !reference [.npm, script]
    - !reference [.panda, script]
    - npm run download:sdk
    needs:
    - prepare caches
    - build external
    artifacts:
        paths:
        - sdk-patched
        - sdk-patched-arkts
        expire_in: 1 day